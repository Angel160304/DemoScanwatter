<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial;
            background: #f5f5f5;
            padding: 20px;
        }

        #chartContainer {
            width: 90%;
            margin: auto;
        }
    </style>
</head>
<body>

    <h2>Dashboard — Datos del Sensor</h2>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        // =================== CONFIGURACIÓN FIREBASE ===================
        const firebaseConfig = {
            apiKey: "AIzaSyCaycR8mbrfm7xI4yLH-FoHGtsb7J15VI0",
            authDomain: "scanwatter-1bf04.firebaseapp.com",
            databaseURL: "https://scanwatter-1bf04-default-rtdb.firebaseio.com",
            projectId: "scanwatter-1bf04",
            storageBucket: "scanwatter-1bf04.appspot.com",
            messagingSenderId: "813351751073",
            appId: "1:813351751073:web:2f53f8def74306a0dcf5d6"
        };

        firebase.initializeApp(firebaseConfig);

        // =================== VERIFICAR SESIÓN ===================
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                window.location.href = "index.html"; // REDIRECCIÓN SI NO HAY LOGIN
            }
        });

        // =================== VARIABLES PARA LA GRÁFICA ===================
        const labels = [];
        const dataValues = [];

        const ctx = document.getElementById('myChart').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nivel del Sensor',
                    data: dataValues,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                }]
            }
        });

        // =================== LECTURA EN TIEMPO REAL ===================
        const ref = firebase.database().ref("sensores/lecturas");

        ref.on("value", snapshot => {
            const data = snapshot.val();

            labels.length = 0;
            dataValues.length = 0;

            if (data) {
                Object.keys(data).forEach(key => {
                    labels.push(key);
                    dataValues.push(data[key]);
                });
            }

            chart.update();
        });
    </script>

</body>
</html>
