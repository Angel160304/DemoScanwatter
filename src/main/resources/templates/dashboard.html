<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - ScanWatter</title>

    <!--  SDKs Firebase (OBLIGATORIO) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>

        // =================== 1. Verificar token ===================
        const firebaseToken = localStorage.getItem('firebaseIdToken');

        if (!firebaseToken) {
            alert("Sesi贸n expirada o no iniciada.");
            window.location.href = 'login.html';
            throw new Error("Token faltante.");
        }

        // =================== 2. Autenticar contra el backend ===================
        async function authenticateBackendSession() {
            try {
                const response = await fetch("/api/check", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${firebaseToken}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem("firebaseIdToken");
                    alert("Tu sesi贸n ha expirado.");
                    window.location.href = "login.html";
                }
            } catch (error) {
                console.error("Error conectando al backend:", error);
            }
        }
        authenticateBackendSession();

        // =================== 3. Configuraci贸n Firebase ===================
        const firebaseConfig = {
            apiKey: "AIzaSyCaycR8mbrfm7xI4yLH-FoHGtsb7J15VI0",
            authDomain: "scanwatter-1bf04.firebaseapp.com",
            databaseURL: "https://scanwatter-1bf04-default-rtdb.firebaseio.com",
            projectId: "scanwatter-1bf04",
            storageBucket: "scanwatter-1bf04.firebasestorage.app",
            messagingSenderId: "19246885609",
            appId: "1:19246885609:web:c50bc7012698ddfcddde78",
            measurementId: "G-GCR3RHEQQQ"
        };

        firebase.initializeApp(firebaseConfig);


        // =================== 4. Cargar datos de Realtime ===================
        document.addEventListener("DOMContentLoaded", () => {

            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    alert("Debes iniciar sesi贸n.");
                    window.location.href = "login.html";
                    return;
                }

                cargarMedidas(user.uid);
            });
        });

        function cargarMedidas(uid) {
            const db = firebase.database();

            db.ref(`users/${uid}/medidas`).on("value", snapshot => {
                const datos = snapshot.val();
                console.log("Datos del Realtime:", datos);

                if (!datos) {
                    console.warn("No hay datos para este usuario.");
                    return;
                }

                // Aqu铆 puedes invocar tus funciones: loadDay(), renderChart(), etc.
            });
        }

    </script>
</head>

<body class="dashboard-body">

    <!-- TU DISEO NO FUE MODIFICADO -->

</body>
</html>
